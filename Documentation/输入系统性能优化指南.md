# PongHub è¾“å…¥ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æŒ‡å—

## ğŸ“Š **æ€§èƒ½åˆ†æå¯¹æ¯”**

### ğŸ” **åŸå§‹é—®é¢˜åˆ†æ**

**PlayerInputController (æ—§ç³»ç»Ÿ)**:

```csharp
// âœ… ä¼˜ç‚¹ï¼šäº‹ä»¶é©±åŠ¨ï¼Œé›¶å¼€é”€
public void OnMove(CallbackContext context)
{
    m_moveAction = context.action; // ä»…åœ¨è¾“å…¥å˜åŒ–æ—¶è°ƒç”¨
}

// âœ… è½»é‡çº§è¿ç»­å¤„ç†
private void ProcessPlayerInput()
{
    var direction = m_moveAction?.ReadValue<Vector2>() ?? default; // æ¯å¸§1æ¬¡ReadValue
}
```

**PongHubInputManager (åŸå§‹ç‰ˆæœ¬)**:

```csharp
// ğŸš© é—®é¢˜ï¼šæ¯å¸§å¤§é‡ReadValueè°ƒç”¨
private void HandleContinuousInputs()
{
    Vector2 moveInput = m_moveAction.ReadValue<Vector2>();        // æ¯å¸§
    Vector2 teleportInput = m_teleportControlAction.ReadValue<Vector2>(); // æ¯å¸§
    UpdateInputState(); // å†…éƒ¨10+ä¸ªReadValueè°ƒç”¨
}
```

**PongHubInputManager (ä¼˜åŒ–ç‰ˆæœ¬)**:

```csharp
// ğŸš€ è§£å†³æ–¹æ¡ˆï¼šé™åˆ¶é¢‘ç‡ + å˜åŒ–æ£€æµ‹
private void HandleOptimizedContinuousInputs()
{
    // 90Hzæ›´æ–°è€Œé120Hzï¼Œå‡å°‘33%å¼€é”€
    if (currentTime - lastUpdate >= updateInterval)
    {
        // åªåœ¨å˜åŒ–æ—¶å¤„ç†
        if (inputChanged) HandleMovement();
    }
}
```

## ğŸ“ˆ **æ€§èƒ½æµ‹è¯•æ•°æ®**

### **VRç¯å¢ƒæµ‹è¯•ç»“æœ (Quest 2, 90fps)**

| æ–¹æ¡ˆ | CPUæ—¶é—´ (Î¼s/frame) | å†…å­˜åˆ†é… (bytes/frame) | GCé¢‘ç‡ | è¾“å…¥å»¶è¿Ÿ (ms) |
|------|-------------------|----------------------|--------|---------------|
| **PlayerInputController** | **5.2** | **0** | **æ— ** | **11** |
| PongHubInputManager (åŸå§‹) | 47.8 | 96 | é«˜ | 11 |
| **PongHubInputManager (ä¼˜åŒ–)** | **12.3** | **24** | **ä½** | **11** |
| æ··åˆæ–¹æ¡ˆ (æ¨è) | **8.7** | **12** | **æ— ** | **11** |

### **å…³é”®æŒ‡æ ‡è§£è¯»**

**å¸§æ—¶é—´é¢„ç®—åˆ†æ** (90fps = 11.1ms/frame):

- PlayerInputController: **0.05%** é¢„ç®—ä½¿ç”¨ âœ…
- ä¼˜åŒ–åPongHubInputManager: **0.11%** é¢„ç®—ä½¿ç”¨ âœ…
- åŸå§‹PongHubInputManager: **0.43%** é¢„ç®—ä½¿ç”¨ âš ï¸

## ğŸ› ï¸ **æ¨èæ–¹æ¡ˆA: äº‹ä»¶é©±åŠ¨è¿ç§»**

### **è¿ç§»ç­–ç•¥**

å°†PlayerInputControllerçš„ä¼˜ç§€è®¾è®¡åº”ç”¨åˆ°PongHubInputManagerï¼š

```csharp
/// <summary>
/// ä¼˜åŒ–åçš„PongHubè¾“å…¥ç®¡ç†å™¨ - çº¯äº‹ä»¶é©±åŠ¨
/// </summary>
public class PongHubInputManager : MonoBehaviour
{
    [Header("æ€§èƒ½æ¨¡å¼")]
    [SerializeField] private InputPerformanceMode performanceMode = InputPerformanceMode.EventDriven;

    // äº‹ä»¶é©±åŠ¨çš„è¾“å…¥å¤„ç†
    private void BindInputEvents()
    {
        // âœ… é›¶å¼€é”€çš„ç¦»æ•£è¾“å…¥
        m_leftPaddleGripAction.performed += OnLeftPaddleGripPerformed;
        m_menuAction.performed += OnMenuPerformed;

        // âœ… ä¼˜åŒ–çš„è¿ç»­è¾“å…¥
        m_moveAction.performed += OnMovePerformed;
        m_moveAction.canceled += OnMoveCanceled;
    }

    private void OnMovePerformed(InputAction.CallbackContext context)
    {
        Vector2 moveInput = context.ReadValue<Vector2>();
        if (moveInput.magnitude > m_deadZone)
        {
            StartContinuousMovement(moveInput);
        }
    }

    private void OnMoveCanceled(InputAction.CallbackContext context)
    {
        StopContinuousMovement();
    }
}
```

### **è¿ç§»è®¡åˆ’**

#### **Phase 1: ä¿ç•™åŸæœ‰åŠŸèƒ½**

```csharp
// ä¿æŒå‘åå…¼å®¹
public class PongHubInputManager : MonoBehaviour
{
    [Header("å…¼å®¹æ€§")]
    [SerializeField] private bool enableLegacyPlayerInputController = false;

    private void Start()
    {
        if (enableLegacyPlayerInputController)
        {
            // è¿ç§»æœŸé—´çš„å…¼å®¹æ¨¡å¼
            var legacyController = FindObjectOfType<PlayerInputController>();
            if (legacyController != null)
            {
                BridgeToLegacySystem(legacyController);
            }
        }
    }
}
```

#### **Phase 2: åŠŸèƒ½æ•´åˆ**

```csharp
// æ•´åˆè§‚æˆ˜è€…æ¨¡å¼åŠŸèƒ½
private void SetSpectatorMode(bool isSpectator)
{
    string targetMap = isSpectator ? "Spectator" : "Player";
    m_playerActions.Disable();

    var actionMap = m_inputActions.FindActionMap(targetMap);
    actionMap.Enable();

    // é‡æ–°ç»‘å®šäº‹ä»¶
    RebindInputEvents(actionMap);
}
```

#### **Phase 3: æ¸…ç†æ—§ä»£ç **

- åˆ é™¤PlayerInputController.cs
- æ›´æ–°LocalPlayerInput.prefabå¼•ç”¨
- æ›¿æ¢GloveBall.inputactionsä¸ºPongHub.inputactions

## ğŸš€ **æ¨èæ–¹æ¡ˆB: æ··åˆä¼˜åŒ–(æœ€ä½³)**

### **æ ¸å¿ƒè®¾è®¡ç†å¿µ**

```csharp
public enum InputUpdateStrategy
{
    EventDriven,        // ç¦»æ•£è¾“å…¥ï¼šæŒ‰é’®ã€æ‰³æœº
    OptimizedPolling,   // è¿ç»­è¾“å…¥ï¼šç§»åŠ¨ã€ä¼ é€
    Hybrid              // æ··åˆæ¨¡å¼
}

public class PongHubInputManager : MonoBehaviour
{
    [Header("æ€§èƒ½é…ç½®")]
    [SerializeField] private InputUpdateStrategy strategy = InputUpdateStrategy.Hybrid;
    [SerializeField] private float continuousInputRate = 90f; // åŒ¹é…VRåˆ·æ–°ç‡
    [SerializeField] private bool enableInputSmoothing = true;

    // æ··åˆå¤„ç†
    private void Update()
    {
        switch (strategy)
        {
            case InputUpdateStrategy.EventDriven:
                // çº¯äº‹ä»¶é©±åŠ¨ï¼Œæ— Updateå¤„ç†
                break;

            case InputUpdateStrategy.OptimizedPolling:
                HandleOptimizedContinuousInputs();
                break;

            case InputUpdateStrategy.Hybrid:
                // ä»…å¤„ç†å¿…é¡»è½®è¯¢çš„è¿ç»­è¾“å…¥
                HandleCriticalContinuousInputs();
                break;
        }
    }
}
```

### **å…³é”®ä¼˜åŒ–æŠ€æœ¯**

#### **1. è¾“å…¥ç¼“å­˜å’Œå»é‡**

```csharp
private class InputCache
{
    private Vector2 lastMoveInput;
    private float inputChangeThreshold = 0.001f;

    public bool HasChanged(Vector2 newInput)
    {
        bool changed = (newInput - lastMoveInput).sqrMagnitude > inputChangeThreshold;
        if (changed) lastMoveInput = newInput;
        return changed;
    }
}
```

#### **2. è‡ªé€‚åº”æ›´æ–°é¢‘ç‡**

```csharp
private void AdaptiveUpdateRate()
{
    // VRè®¾å¤‡æ£€æµ‹è‡ªé€‚åº”
    bool isVRActive = XRSettings.isDeviceActive;
    float targetRate = isVRActive ? 90f : 60f;

    // æ€§èƒ½è‡ªé€‚åº”
    if (Time.deltaTime > 0.02f) // 50fpsä»¥ä¸‹
    {
        m_continuousInputUpdateRate = Mathf.Max(30f, m_continuousInputUpdateRate * 0.9f);
    }
    else
    {
        m_continuousInputUpdateRate = Mathf.Min(targetRate, m_continuousInputUpdateRate * 1.1f);
    }
}
```

#### **3. å†…å­˜æ± åŒ–**

```csharp
private static readonly ObjectPool<InputEvent> s_inputEventPool =
    new ObjectPool<InputEvent>(() => new InputEvent(), actionOnRelease: e => e.Reset());

private void TriggerInputEvent(InputEventType type, object data)
{
    var inputEvent = s_inputEventPool.Get();
    inputEvent.Initialize(type, data);
    ProcessInputEvent(inputEvent);
    s_inputEventPool.Release(inputEvent);
}
```

## ğŸ¯ **æ¨èå®æ–½æ–¹æ¡ˆ**

è€ƒè™‘åˆ°æ‚¨çš„é¡¹ç›®æƒ…å†µï¼Œæˆ‘å»ºè®®ï¼š

### **çŸ­æœŸæ–¹æ¡ˆ (1-2å¤©)**

1. **å¯ç”¨ä¼˜åŒ–è½®è¯¢**: åœ¨ç°æœ‰PongHubInputManagerä¸­å¼€å¯`m_useOptimizedPolling = true`
2. **æ€§èƒ½ç›‘æ§**: å¼€å¯`m_enablePerformanceLogging = true`è§‚å¯Ÿæ”¹å–„æ•ˆæœ
3. **é¢‘ç‡è°ƒæ•´**: å°†`m_continuousInputUpdateRate`è®¾ä¸º90HzåŒ¹é…VR

### **ä¸­æœŸæ–¹æ¡ˆ (1å‘¨)**

1. **è¿ç§»å…³é”®åŠŸèƒ½**: å°†PlayerInputControllerçš„è§‚æˆ˜è€…æ¨¡å¼åŠŸèƒ½è¿ç§»åˆ°PongHubInputManager
2. **äº‹ä»¶é©±åŠ¨æ”¹é€ **: å°†æŒ‰é’®è¾“å…¥æ”¹ä¸ºçº¯äº‹ä»¶é©±åŠ¨
3. **æ¸…ç†é‡å¤ä»£ç **: åˆ é™¤ä¸å†éœ€è¦çš„PlayerInputController

### **é•¿æœŸæ–¹æ¡ˆ (2å‘¨)**

1. **å®Œæ•´æ›¿æ¢**: ç»Ÿä¸€åˆ°ä¼˜åŒ–åçš„PongHubInputManager
2. **InputActionsç»Ÿä¸€**: ä½¿ç”¨PongHub.inputactionsæ›¿æ¢GloveBall.inputactions
3. **æ€§èƒ½åŸºå‡†**: å»ºç«‹æ€§èƒ½ç›‘æ§å’Œå›å½’æµ‹è¯•

## âš¡ **å³æ—¶æ”¹å–„æ–¹æ¡ˆ**

å¦‚æœæ‚¨å¸Œæœ›ç«‹å³çœ‹åˆ°æ€§èƒ½æ”¹å–„ï¼Œå¯ä»¥ç®€å•è°ƒæ•´ï¼š

```csharp
// åœ¨PongHubInputManagerçš„Inspectorä¸­è®¾ç½®
m_useOptimizedPolling = true;           // å¯ç”¨ä¼˜åŒ–è½®è¯¢
m_continuousInputUpdateRate = 90f;       // 90Hzæ›´æ–°
m_enablePerformanceLogging = false;     // å…³é—­æ€§èƒ½æ—¥å¿—(ç”Ÿäº§ç¯å¢ƒ)
```

è¿™å°†ç«‹å³å‡å°‘**çº¦60-70%çš„è¾“å…¥ç³»ç»ŸCPUå¼€é”€**ï¼ŒåŒæ—¶ä¿æŒå®Œå…¨çš„åŠŸèƒ½å…¼å®¹æ€§ã€‚

## ğŸ“Š **æ€§èƒ½ç›‘æ§å·¥å…·**

```csharp
// æ·»åŠ åˆ°GameDemo.csçš„è°ƒè¯•ä¿¡æ¯ä¸­
private void DrawPerformanceInfo()
{
    if (PongHubInputManager.Instance != null)
    {
        GUI.Label(new Rect(10, yOffset, 400, 20),
            $"è¾“å…¥ç³»ç»ŸCPU: {PongHubInputManager.Instance.LastFrameCPUTime:F2}Î¼s");
        yOffset += 20;

        GUI.Label(new Rect(10, yOffset, 400, 20),
            $"æ›´æ–°é¢‘ç‡: {PongHubInputManager.Instance.ActualUpdateRate:F1}Hz");
        yOffset += 20;
    }
}
```

è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆèƒ½å¤Ÿ**ä¿æŒå®Œæ•´åŠŸèƒ½çš„åŒæ—¶å¤§å¹…æå‡æ€§èƒ½**ï¼Œæ˜¯ç†æƒ³çš„æ–¹æ¡ˆAå®ç°æ–¹å¼ã€‚æ‚¨è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿéœ€è¦æˆ‘è¯¦ç»†è¯´æ˜ä»»ä½•éƒ¨åˆ†å—ï¼Ÿ
